#!/usr/bin/env bash
# Pre-commit 훅:
# 1) 변경된 Python 파일 lint/포맷 검사
# 2) mypy 타입 검사
# 3) 단위 테스트 (E2E는 GitHub PR 파이프라인에서 통합 검증)
#
# 설치: bash scripts/install-hooks.sh

set -euo pipefail

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[pre-commit]${NC} $*"; }
warn() { echo -e "${YELLOW}[pre-commit]${NC} $*"; }
fail() { echo -e "${RED}[pre-commit]${NC} $*"; exit 1; }

cd "$(git rev-parse --show-toplevel)"

# 커밋 스테이징 영역 기준으로 검사 대상 Python 파일 추출
staged_files=()
while IFS= read -r file; do
    staged_files+=("${file}")
done < <(
    git diff --cached --name-only --diff-filter=ACMR \
        | grep -E '\.py$' || true
)

if [ "${#staged_files[@]}" -eq 0 ]; then
    info "스테이징된 Python 파일이 없어 기본 경로를 검사합니다."
    staged_files=(tubearchive/ tests/)
fi

# 1. ruff lint
info "ruff check 실행 중..."
if ! uv run ruff check "${staged_files[@]}"; then
    fail "ruff check 실패. 위반 사항을 수정한 후 다시 커밋하세요."
fi

# 2. ruff format (검사 모드)
info "ruff format 검사 중..."
if ! uv run ruff format --check "${staged_files[@]}"; then
    fail "ruff format 미적용 파일이 있습니다. uv run ruff format 실행 후 다시 커밋하세요."
fi

# 3. mypy (strict 타입 검사)
info "mypy 실행 중..."
if ! uv run mypy tubearchive/; then
    fail "mypy 실패. 타입 오류를 수정한 후 다시 커밋하세요."
fi

# 4. pytest unit
info "pytest unit 실행 중..."
if ! uv run pytest tests/unit/ -q; then
    fail "단위 테스트 실패. 테스트를 수정한 후 다시 커밋하세요."
fi

info "모든 검사 통과!"
